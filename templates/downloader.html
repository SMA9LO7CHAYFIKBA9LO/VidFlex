{% extends "base.html" %}

{% block title %}MediaFlow ‚Äî Video Downloader{% endblock %}
{% block description %}Download videos from YouTube, Instagram, Facebook and TikTok in any resolution or as MP3.{%
endblock %}

{% block content %}

<!-- ===== HERO ===== -->
<section class="hero">
    <div class="hero-bg-orb orb-1"></div>
    <div class="hero-bg-orb orb-2"></div>
    <div class="container hero-content">
        <h1>Universal<br /><span class="gradient-text">Video Downloader</span></h1>
        <p class="hero-sub">Grab videos and audio from YouTube, Instagram, Facebook and TikTok ‚Äî pick the exact quality
            you want.</p>
        <div class="hero-badges">
            <span class="badge">üé¨ YouTube</span>
            <span class="badge">üì∏ Instagram</span>
            <span class="badge">üëç Facebook</span>
            <span class="badge">üéµ TikTok</span>
        </div>
    </div>
</section>

<!-- ===== DOWNLOADER TOOL ===== -->
<section class="section">
    <div class="container">

        <!-- ===== COOKIE AUTH PANEL ===== -->
        <div class="card" id="cookie-panel" style="margin-bottom:1.5rem;border:1px dashed rgba(255,255,255,0.15);">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
                <div>
                    <div style="font-weight:600;font-size:1rem;margin-bottom:.25rem;">üîë YouTube Authentication</div>
                    <div style="font-size:.85rem;opacity:.65;" id="cookie-status-text">Checking...</div>
                </div>
                <label for="cookie-file-input" id="cookie-upload-label" class="btn-primary"
                    style="cursor:pointer;padding:.55rem 1.2rem;font-size:.9rem;display:none;">
                    üìÇ Upload cookies.txt
                </label>
                <input type="file" id="cookie-file-input" accept=".txt" style="display:none;" />
                <span id="cookie-ok-badge"
                    style="display:none;background:rgba(34,197,94,.15);color:#22c55e;border:1px solid rgba(34,197,94,.4);border-radius:2rem;padding:.35rem 1rem;font-size:.85rem;font-weight:600;">‚úÖ
                    Authenticated</span>
            </div>
            <div id="cookie-upload-hint" style="margin-top:.75rem;font-size:.8rem;opacity:.5;display:none;">
                Export your YouTube cookies with the <strong>Get cookies.txt LOCALLY</strong> Chrome extension, then
                upload the file here.
            </div>
            <div id="cookie-upload-result" style="margin-top:.5rem;font-size:.85rem;display:none;"></div>
        </div>

        <div class="card">
            <!-- URL Input -->
            <div class="input-group" id="dl-input-group">
                <div class="url-input-wrap">
                    <span class="url-input-icon">üîó</span>
                    <input type="url" id="dl-url" placeholder="https://www.youtube.com/watch?v=..." autocomplete="off"
                        spellcheck="false" />
                    <button id="dl-fetch-btn" class="btn-primary" aria-label="Fetch video info">
                        <span class="btn-text">Fetch</span>
                        <span class="btn-spinner hidden" aria-hidden="true"></span>
                    </button>
                </div>
                <p id="dl-url-error" class="field-error hidden"></p>
            </div>

            <!-- Video Preview -->
            <div id="dl-preview" class="video-preview hidden">
                <img id="dl-thumb" src="" alt="Video thumbnail" class="thumb" />
                <div class="video-meta">
                    <h3 id="dl-title" class="video-title"></h3>
                    <div class="meta-row">
                        <span id="dl-uploader" class="meta-chip"></span>
                        <span id="dl-platform" class="meta-chip platform-chip"></span>
                        <span id="dl-duration" class="meta-chip"></span>
                    </div>
                </div>
            </div>

            <!-- Download Options -->
            <div id="dl-options" class="download-options hidden">
                <div class="options-row">
                    <div class="option-block">
                        <label class="option-label">Type</label>
                        <div class="toggle-group" role="group" aria-label="Download type">
                            <button class="toggle-btn active" data-value="video" id="type-video">üé¨ Video (MP4)</button>
                            <button class="toggle-btn" data-value="audio" id="type-audio">üéµ Audio (MP3)</button>
                        </div>
                    </div>

                    <div class="option-block" id="resolution-block">
                        <label class="option-label" for="dl-resolution">Resolution</label>
                        <div class="custom-select-wrap">
                            <select id="dl-resolution" class="custom-select"></select>
                            <span class="select-arrow">‚ñæ</span>
                        </div>
                    </div>
                </div>

                <button id="dl-download-btn" class="btn-download">
                    <span class="btn-download-icon">‚¨á</span>
                    <span class="btn-download-text">Download</span>
                    <span class="btn-spinner hidden" aria-hidden="true"></span>
                </button>
                <p id="dl-download-status" class="status-msg hidden"></p>
            </div>
        </div><!-- /card -->

        <!-- How-to hint -->
        <div class="hint-row">
            <div class="hint-card">
                <div class="hint-icon">1Ô∏è‚É£</div>
                <p>Paste the video URL above</p>
            </div>
            <div class="hint-arrow">‚Üí</div>
            <div class="hint-card">
                <div class="hint-icon">2Ô∏è‚É£</div>
                <p>Click <strong>Fetch</strong> to load info</p>
            </div>
            <div class="hint-arrow">‚Üí</div>
            <div class="hint-card">
                <div class="hint-icon">3Ô∏è‚É£</div>
                <p>Pick quality &amp; click <strong>Download</strong></p>
            </div>
        </div>

    </div>
</section>

<script>
    (function () {
        const statusText = document.getElementById('cookie-status-text');
        const uploadLabel = document.getElementById('cookie-upload-label');
        const uploadHint = document.getElementById('cookie-upload-hint');
        const okBadge = document.getElementById('cookie-ok-badge');
        const fileInput = document.getElementById('cookie-file-input');
        const resultEl = document.getElementById('cookie-upload-result');

        function showAuthenticated() {
            statusText.textContent = 'Your YouTube session is active. Downloads should work without restrictions.';
            okBadge.style.display = 'inline-flex';
            uploadLabel.style.display = 'none';
            uploadHint.style.display = 'none';
        }
        function showUnauthenticated() {
            statusText.textContent = 'No cookies found. YouTube may block some downloads. Upload your cookies.txt to fix this.';
            uploadLabel.style.display = 'inline-flex';
            uploadHint.style.display = 'block';
            okBadge.style.display = 'none';
        }

        fetch('/api/cookies-status')
            .then(r => r.json())
            .then(d => { d.has_cookies && d.size_bytes > 100 ? showAuthenticated() : showUnauthenticated(); })
            .catch(() => showUnauthenticated());

        fileInput.addEventListener('change', function () {
            const file = this.files[0];
            if (!file) return;
            const fd = new FormData();
            fd.append('cookies', file);
            resultEl.style.display = 'block';
            resultEl.style.color = '#94a3b8';
            resultEl.textContent = 'Uploading...';
            fetch('/api/upload-cookies', { method: 'POST', body: fd })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        resultEl.style.color = '#22c55e';
                        resultEl.textContent = '‚úÖ ' + d.message;
                        showAuthenticated();
                    } else {
                        resultEl.style.color = '#f87171';
                        resultEl.textContent = '‚ùå ' + (d.error || 'Upload failed');
                    }
                })
                .catch(() => { resultEl.style.color = '#f87171'; resultEl.textContent = '‚ùå Network error'; });
        });
    })();
</script>

{% endblock %}